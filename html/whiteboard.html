<!doctype html>
<html lang=en>
<head>
<meta charset=utf-8>
<title></title>
<style type="text/css"> 
  body {
    background-color: #fff;
    margin: 0px;
    text-align:center;
  }
  canvas {
    background-color:#e1e1e1;
  }
  #title {
    color:white;
  }
  #canvasDiv {
    float:left;
    margin-left:100px;
  }
</style>

</head>
<body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="js/muzzley-sdk.js"></script>
<div id="title">
  <h3>Muzzley Whiteboard Demo</h3>
</div>
<div id="canvasDiv"></div>
<div id="qrCodeImg"></div>
<script>

  var muzzley = require('/lib/main');
  muzzley.connect('wwtbam741', function (activity) {

    // Create qrCode image
    $('<img />', { 'src': activity.qrCodeUrl}).appendTo('#qrCodeImg');

    activity.on('participantJoin', function(participant) {

      participant.changeWidget('trackpad', function (err) {
        participant.on('action', function (action) {
          
          // Trackpad Actions
          if (action.c === 'tp') {
            // action.v is '0.3,0.45' which
            // is the equivalent to x=30%, y=45.5%
            var xy = action.v.split(',');
            var x = parseFloat(xy[0]);
            var y = parseFloat(xy[1]);
            if (action.e === 'press') {
              move(x, y, true);
            }
            if (action.e === 'release') {
              move(x, y, false);
            }
            redraw();
          }
        });
      });
    });
  });

  var canvas;
  var context;
  var movements = [];

  function move(x, y, dragging) {
    var xAbs = canvas.width * x;
    var yAbs = canvas.height * y;

    movements.push({
      x: xAbs,
      y: yAbs,
      dragging: dragging
    });
  }

  function redraw() {
    canvas.width = canvas.width; // Clears the canvas
            
    for (var i=0; i < movements.length; i++) {
      context.beginPath();
      if (movements[i].dragging && i) {
        context.moveTo(movements[i-1].x, movements[i-1].y);
       } else {
         context.moveTo(movements[i].x-1, movements[i].y);
       }
       context.lineTo(movements[i].x, movements[i].y);
       context.closePath();
       context.stroke();
    }
  }

  function setupCanvas() {
    canvas = document.createElement('canvas');
    context = canvas.getContext('2d');
    canvas.width = 600; 
    canvas.height = 300; 
    $("#canvasDiv").append(canvas);
    context.strokeStyle = "#666";
    context.lineJoin = "round";
    context.lineWidth = 10;
  }

  setupCanvas();

</script>
</body>
</html>
